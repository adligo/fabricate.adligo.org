#! /bin/sh

# This is the fabricate shell script, to execute fabricate.
# Licensed by Adligo Inc. 
# http://www.apache.org/licenses/LICENSE-2.0

if [ -z "$FABRICATE_HOME" ]; then
    echo "Fabricate requires the FABRICATE_HOME environment variable to be set."
    exit 1
fi
CLASSPATH=$FABRICATE_HOME/lib/commons-logging-1.2.jar
CLASSPATH=$CLASSPATH:$FABRICATE_HOME/lib/httpcore-4.3.2.jar
CLASSPATH=$CLASSPATH:$FABRICATE_HOME/lib/httpclient-4.3.5.jar
CLASSPATH=$CLASSPATH:$FABRICATE_HOME/lib/@FABRICATE_NAME@.jar 

EXCEPTION=Exception
DEBUG=debug
VERSION=-version
ARGS="$@"
#echo command line args are "$@"
ARGS_FROM_SETUP=`java -cp $CLASSPATH org.adligo.fabricate.FabricateSetup args "$@" `
if [ -z "$ARGS_FROM_SETUP" ]; then
    exit 1
fi

if [ "${ARGS_FROM_SETUP#*$EXCEPTION}" != "$ARGS_FROM_SETUP" ]; then
	echo "Fabrication Failed!"
else
	if [ "${ARGS#*$VERSION}" != "$ARGS" ]; then
		echo "Fabricate by Adligo."
		VERSION=`echo $ARGS_FROM_SETUP | cut -f4 -d"="`
		echo "Version $VERSION" 
		exit 0
	fi
	if [ "${ARGS#*$DEBUG}" != "$ARGS" ]; then
		echo ARGS_FROM_SETUP are $ARGS_FROM_SETUP
	fi
	OPTIONS_FROM_FILE=`java -cp $CLASSPATH org.adligo.fabricate.FabricateSetup opts "$@" $ARGS_FROM_SETUP`
	if [ -z "$OPTIONS_FROM_FILE" ]; then
    	exit 1
	fi

	if [ "${OPTIONS_FROM_FILE#*$EXCEPTION}" != "$OPTIONS_FROM_FILE" ]; then
		echo "$OPTIONS_FROM_FILE"
		echo "Fabrication Failed!"
	else
		if [ "${ARGS#*$DEBUG}" != "$ARGS" ]; then
			echo OPTIONS_FROM_FILE are $OPTIONS_FROM_FILE
		fi
		java  $OPTIONS_FROM_FILE org.adligo.fabricate.Fabricate "$@" $ARGS_FROM_SETUP 
	fi
fi

